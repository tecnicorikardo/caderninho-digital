# üß™ TESTE DETALHADO - Despesas de Estoque

## üîç INVESTIGA√á√ÉO COMPLETA

Vamos rastrear **fio por fio** o que acontece quando voc√™ cria um produto.

---

## üìä FLUXO ESPERADO

### 1. Criar Produto com Estoque

**Entrada:**
- Nome: "Produto Teste"
- Pre√ßo de Custo: R$ 10,00
- Quantidade: 5 unidades

**Sa√≠da Esperada:**
- ‚úÖ Produto criado no Firebase
- ‚úÖ Despesa de R$ 50,00 criada no localStorage
- ‚úÖ Flag `stockGenerated: true` na despesa

---

## üî¨ AN√ÅLISE DO C√ìDIGO

### Arquivo: `src/pages/Stock/index.tsx`

#### Fun√ß√£o: `registerStockExpense` (linha ~110)

```typescript
const registerStockExpense = async (stockData: {
  productName: string;
  quantity: number;
  costPrice: number;
  supplier: string;
}) => {
  if (!user) return;

  try {
    console.log('üí∞ Registrando despesa de estoque no financeiro...');
    
    const totalCost = stockData.quantity * stockData.costPrice;
    
    // Criar transa√ß√£o financeira
    const financialTransaction = {
      id: `stock_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type: 'despesa',
      category: 'Fornecedores',
      description: `Compra de estoque - ${stockData.productName} (${stockData.quantity}x)`,
      amount: totalCost,
      date: new Date().toISOString(),
      paymentMethod: 'dinheiro',
      status: 'pago',
      userId: user.uid,
      createdAt: new Date().toISOString(),
      financialType: 'comercial',
      autoGenerated: true,
      stockGenerated: true, // ‚úÖ FLAG IMPORTANTE
      productName: stockData.productName,
      supplier: stockData.supplier
    };

    // Salvar no localStorage
    const savedTransactions = localStorage.getItem(`transactions_${user.uid}`);
    const transactionsList = savedTransactions ? JSON.parse(savedTransactions) : [];
    transactionsList.push(financialTransaction);
    localStorage.setItem(`transactions_${user.uid}`, JSON.stringify(transactionsList));
    
    console.log('‚úÖ Despesa de estoque registrada no financeiro:', financialTransaction.description);
    
    toast.success(`Despesa de R$ ${totalCost.toFixed(2)} registrada no financeiro!`);
    
  } catch (error) {
    console.error('‚ùå Erro ao registrar despesa de estoque:', error);
  }
};
```

**‚úÖ An√°lise:** C√≥digo est√° correto!

---

### Arquivo: `src/pages/Finance/index.tsx`

#### Fun√ß√£o: `cleanDuplicateTransactions` (linha ~90)

```typescript
transactions.forEach((transaction: any) => {
  // ‚úÖ Identificar e preservar transa√ß√µes de estoque
  if (transaction.stockGenerated || transaction.stockMovementGenerated) {
    stockTransactions.push(transaction);
  } else if (transaction.saleId) {
    // Agrupa por venda
  } else {
    // Outras transa√ß√µes
  }
});

// ‚úÖ Preservar TODAS as transa√ß√µes de estoque
const cleanedTransactions: any[] = [
  ...transactionsWithoutSaleId,
  ...stockTransactions // ‚úÖ Preservadas
];
```

**‚úÖ An√°lise:** C√≥digo est√° correto!

---

## üß™ TESTE PASSO A PASSO

### Teste 1: Criar Produto

1. Abra o console do navegador (F12)
2. V√° em **Estoque**
3. Clique em **Novo Produto**
4. Preencha:
   - Nome: "Teste Despesa"
   - Pre√ßo de Custo: R$ 10,00
   - Quantidade: 5
5. Salve

**Logs Esperados no Console:**
```
üí∞ Registrando despesa de estoque no financeiro...
‚úÖ Despesa de estoque registrada no financeiro: Compra de estoque - Teste Despesa (5x)
```

**Verificar localStorage:**
```javascript
// Cole no console:
const transactions = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
console.log('Total de transa√ß√µes:', transactions.length);
console.log('Transa√ß√µes de estoque:', transactions.filter(t => t.stockGenerated));
```

---

### Teste 2: Recarregar P√°gina de Financeiro

1. V√° em **Financeiro**
2. Abra o console (F12)
3. Recarregue a p√°gina (F5)

**Logs Esperados no Console:**
```
üßπ Limpando transa√ß√µes duplicadas...
‚úÖ Nenhuma duplicata encontrada
üì¶ Transa√ß√µes de estoque: 1
```

**Verificar se a despesa aparece:**
- ‚úÖ Deve aparecer na lista
- ‚úÖ Deve ter badge "üì¶ ESTOQUE"
- ‚úÖ Valor: R$ 50,00

---

### Teste 3: Movimentar Estoque

1. V√° em **Estoque**
2. Clique em **Movimentar** no produto
3. Selecione **Entrada**
4. Quantidade: 3
5. Motivo: "Compra adicional"
6. Confirme

**Logs Esperados no Console:**
```
üì¶ Registrando despesa de movimenta√ß√£o no financeiro...
‚úÖ Despesa de movimenta√ß√£o registrada: Entrada de estoque - Teste Despesa (3x) - Compra adicional
```

**Verificar localStorage:**
```javascript
const transactions = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
console.log('Transa√ß√µes de estoque:', transactions.filter(t => t.stockGenerated || t.stockMovementGenerated).length);
// Deve mostrar: 2
```

---

### Teste 4: Recarregar Financeiro Novamente

1. V√° em **Financeiro**
2. Recarregue (F5)

**Logs Esperados:**
```
üßπ Limpando transa√ß√µes duplicadas...
‚úÖ Nenhuma duplicata encontrada
üì¶ Transa√ß√µes de estoque: 2
```

**Verificar:**
- ‚úÖ Deve ter 2 despesas de estoque
- ‚úÖ R$ 50,00 (produto inicial)
- ‚úÖ R$ 30,00 (movimenta√ß√£o)

---

## üêõ POSS√çVEIS PROBLEMAS

### Problema 1: Despesas N√£o Aparecem

**Causa:** localStorage n√£o est√° sendo salvo

**Verifica√ß√£o:**
```javascript
// Cole no console:
localStorage.getItem('transactions_SEU_USER_ID')
```

**Se retornar `null`:**
- Problema na cria√ß√£o da despesa
- Verificar se `user.uid` est√° correto

---

### Problema 2: Despesas Aparecem e Somem

**Causa:** `cleanDuplicateTransactions` est√° removendo

**Verifica√ß√£o:**
```javascript
// Antes de recarregar:
const before = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
console.log('Antes:', before.filter(t => t.stockGenerated).length);

// Depois de recarregar:
const after = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
console.log('Depois:', after.filter(t => t.stockGenerated).length);
```

**Se os n√∫meros forem diferentes:**
- A fun√ß√£o est√° removendo as transa√ß√µes
- Verificar se a flag `stockGenerated` est√° presente

---

### Problema 3: Flag N√£o Est√° Sendo Salva

**Causa:** Objeto n√£o tem a propriedade `stockGenerated`

**Verifica√ß√£o:**
```javascript
const transactions = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
const stockTrans = transactions.find(t => t.description.includes('Compra de estoque'));
console.log('Transa√ß√£o:', stockTrans);
console.log('Tem stockGenerated?', stockTrans.stockGenerated);
```

**Se `stockGenerated` for `undefined`:**
- A flag n√£o est√° sendo salva
- Problema no c√≥digo de cria√ß√£o

---

## üîß SOLU√á√ïES

### Solu√ß√£o 1: Adicionar Logs Detalhados

Vamos adicionar logs para rastrear exatamente o que est√° acontecendo:

```typescript
// Em registerStockExpense, ANTES de salvar:
console.log('üìä Transa√ß√£o que ser√° salva:', financialTransaction);
console.log('üîë Flags:', {
  stockGenerated: financialTransaction.stockGenerated,
  autoGenerated: financialTransaction.autoGenerated
});

// DEPOIS de salvar:
const saved = JSON.parse(localStorage.getItem(`transactions_${user.uid}`));
const lastTransaction = saved[saved.length - 1];
console.log('üì¶ √öltima transa√ß√£o salva:', lastTransaction);
console.log('‚úÖ Tem stockGenerated?', lastTransaction.stockGenerated);
```

---

### Solu√ß√£o 2: Verificar se cleanDuplicateTransactions Est√° Sendo Chamada

```typescript
// No in√≠cio de cleanDuplicateTransactions:
console.log('üßπ INICIANDO LIMPEZA');
console.log('üìä Total de transa√ß√µes:', transactions.length);

// Ao separar:
console.log('üì¶ Transa√ß√µes de estoque encontradas:', stockTransactions.length);
console.log('üõçÔ∏è Transa√ß√µes de venda:', transactionsBySaleId.size);
console.log('üìù Transa√ß√µes sem saleId:', transactionsWithoutSaleId.length);

// Ao final:
console.log('‚úÖ Total ap√≥s limpeza:', cleanedTransactions.length);
```

---

### Solu√ß√£o 3: Desabilitar Temporariamente a Limpeza

Para testar se o problema √© a limpeza:

```typescript
// Em src/pages/Finance/index.tsx, linha ~51
useEffect(() => {
  loadTransactions();
  // cleanDuplicateTransactions(); // ‚ùå COMENTAR TEMPORARIAMENTE
  syncSalesAsRevenue();
}, []);
```

**Teste:**
1. Comente a linha
2. Fa√ßa build e deploy
3. Crie um produto
4. Recarregue financeiro
5. Se a despesa continuar, o problema √© a limpeza

---

## üìù CHECKLIST DE VERIFICA√á√ÉO

Execute este checklist para identificar o problema:

- [ ] 1. Criar produto com estoque
- [ ] 2. Verificar console: "‚úÖ Despesa de estoque registrada"
- [ ] 3. Verificar localStorage: transa√ß√£o existe?
- [ ] 4. Verificar localStorage: tem flag `stockGenerated: true`?
- [ ] 5. Ir em Financeiro
- [ ] 6. Verificar se despesa aparece
- [ ] 7. Recarregar p√°gina (F5)
- [ ] 8. Verificar console: "üì¶ Transa√ß√µes de estoque: X"
- [ ] 9. Verificar se despesa continua aparecendo
- [ ] 10. Verificar localStorage novamente: transa√ß√£o ainda existe?

---

## üéØ PR√ìXIMOS PASSOS

**Fa√ßa o teste acima e me diga:**

1. Em qual passo o problema acontece?
2. Quais logs aparecem no console?
3. O que tem no localStorage antes e depois de recarregar?

**Cole aqui:**
```javascript
// Resultado deste comando:
const trans = JSON.parse(localStorage.getItem('transactions_SEU_USER_ID'));
console.log('Total:', trans.length);
console.log('Com stockGenerated:', trans.filter(t => t.stockGenerated).length);
console.log('Com stockMovementGenerated:', trans.filter(t => t.stockMovementGenerated).length);
```

Com essas informa√ß√µes, vou identificar exatamente onde est√° o problema!
